# linux.do 收藏增强 篡改猴脚本（Tampermonkey）补充 PRD

说明：以 Edge 扩展（Manifest V3）为主实现；本文件仅作为篡改猴脚本形态的补充说明与对照，尽量与扩展版的功能、数据模型和验收标准保持一致，便于快速迁移。

## 目标

在 `linux.do`（Discourse 站点）上，用篡改猴（Tampermonkey）脚本读取当前登录用户的「收藏帖子」并做可搜索、可多标签筛选的整理展示；以用户本地为中心，持久化 AI 分类结果与自定义标签。

## 运行范围与权限

- 页面匹配：`https://linux.do/u/*/activity/bookmarks`（后续可扩展到 `?page=` 分页）
- 请求方式：脚本所有请求均在同源、携带用户 Cookie 的上下文中发起（`fetch` 或 `GM_xmlhttpRequest` 且 `withCredentials: true`），确保使用用户权限访问正文与接口，避免被拦截
- 前置条件：用户已登录 `linux.do`

## 功能清单（按优先级）

1) 悬浮窗 UI（macOS 风格）
- 居中弹出，可拖拽、可最小化（右上角 `×`），支持开/关按钮与快捷键（默认 `⌘/Ctrl + K`）
- 简洁列表样式：所有帖子以长列表展示（标题 + 作者 + 时间 + 原生标签 + AI 标签）
- 顶部搜索框：按标题关键词即时过滤
- 多选标签筛选（AND 逻辑）：仅显示同时命中所选标签的帖子
- 标签展示：显示 A. 标题、B. 作者、原生标签、脚本预制标签、用户自定义标签

2) 数据获取
- 默认方案：自动加载全部收藏（分页抓取），统一处理并展示；支持大集合，首次可能稍慢
- 每条收藏：抓取标题、作者、帖链、原生标签、正文摘要/全文（尽量抓全文；优先 JSON 接口，失败回退 HTML 解析）

3) 三层“智能标签”系统
- 来源1：原生标签（必保留，自动读取）
- 来源2：脚本预制标签（可禁用、不可改名；用于冷启动）
- 来源3：用户自定义标签（可增删改；独立“标签管理”面板）

4) AI 多标签分类（决策者，而非生成者）
- 候选池 = 预制标签 + 用户自定标签（可选地加入“关键词簇”作为标签组）
- Prompt 只允许从候选里勾选，输出严格 JSON 数组
- 新收藏或未分类的帖子增量处理；已有人为修改的标签永久优先级最高

5) 持久化与同步
- 默认 IndexedDB（大数据量更稳）；配置、开关与轻量索引用 `localStorage`
- 支持导出/导入（JSON 文件）以便多设备迁移

6) 人工校正
- 帖子行内“编辑标签”按钮：手动增删任何标签；标记为“已人工修订”，后续 AI 不覆盖

7) 性能与健壮性
- 分页抓取并发（默认 3–5）、失败重试、超时回退
- 渐进渲染（先标题/作者，后补正文与标签）
- 断点续扫：记住已抓取分页与已分类帖子（哈希/版本号）

8) 可选（增强）
- 作者维度筛选（多选 AND/OR 可切换，默认 AND）
- 排序：最新收藏 / 最新更新 / 作者 A→Z / 命中标签数
- 关键词簇（由 AI 从正文提取 N 个“主题词”，作为只读的辅助筛选组；不与标签混淆）

## 配置面板（必须项）

- API Base URL：如 `https://api.openai.com/v1` / 私有代理 / 本地服务
- API Key：用于认证（仅本地保存，不外发）
- Model 名称：如 `gpt-4o-mini`、`gpt-4-turbo`、`llama3` 等
- 可选高级项：
  - 额外请求头（如 `x-foo: bar`），适配非官方兼容接口
  - 最大并发、超时时间、失败重试次数
  - 单帖最大字数（超长正文自动截断或分段总结后再分类）
  - 费用保护（每次最多处理 N 篇 / 每日配额）

## 预制标签（建议初始集合，可按需禁用）

技术教程、环境搭建、故障排查、性能优化、安全实践、网络配置、容器/Docker、虚拟化/KVM、硬件讨论、软件推荐、发行版/包管理、Shell/脚本、系统服务、存储/备份、监控/日志、DevOps/CICD、云/边缘、数据库、中间件、Nginx/HTTP、内核/驱动、桌面/美化、问答/求助、经验分享、公告/活动

## AI 调用约束（核心）

- 输入：`{candidate_tags[], post_title, post_body}`（`post_body` 可截断到 N 字上限，并附“正文片段计数/摘要”）
- 系统提示：你是分类器，只能从 `candidate_tags` 里选择 0..N 个，不得新增标签；输出纯 JSON 数组，如 `["技术教程","Docker"]`
- 容错：若返回非 JSON，自动重试一次；再失败则标记“AI 待定”，允许手动补充
- 多语言：帖子中文/英文皆可；分类标签统一中文（默认）

## 数据模型（简版）

- `Post`：`id`（topicId#postId）、`title`、`author`、`url`、`createdAt`、`updatedAt`、`nativeTags[]`、`body`（text 或片段）、`hash`（正文哈希）
- `Classify`：`postId`、`aiTags[]`、`userTags[]`、`locked`（人为修改）、`modelSignature`（base+model 版本戳）、`ts`
- `TagDict`：`preset[]`、`user[]`（均含 `name`、`enabled`）
- `Settings`：API 配置、并发/超时、UI 偏好等
- `Index`：分页游标、已抓取列表、失败重试计数

## 交互流（默认）

1. 进入 `.../activity/bookmarks` → 悬浮窗按钮出现 → 点击打开
2. 首次使用进入设置面板：填 `API Base/Key/Model`，保存
3. 自动开始抓取所有分页收藏项 → 渐进展示
4. 对未分类帖子触发 AI 分类（批量节流）；得到 `aiTags` 并保存
5. 用户多选标签 + 搜索标题 → 列表即时过滤（AND 逻辑）
6. 需要时手动“编辑标签”；被编辑的帖子 `locked=true`，AI 不再覆盖
7. 导出/导入（可选）

## 边界与异常

- 已删除/私密帖子：记录“不可访问”状态并从列表剔除（可显示灰条与原因）
- 接口节流/失败：指数退避 + 提示；允许暂停/继续
- DOM/接口变更：解析失败回退到 HTML 解析；均失败时提示“适配待更新”
- 大集合：首屏仅渲染视区 + 虚拟列表；正文按需加载；AI 按批次流控

## 安全与隐私

- 不上传用户数据到第三方，除你主动配置的 AI 接口外
- 本地存储可一键清除；支持设置“仅会话内保存”

## 你需要提供的信息（一次到位清单）

必填
1. API Base URL（例：`https://api.openai.com/v1` / 你的代理地址）
2. API Key（会本地保存）
3. Model 名称（例：`gpt-4o-mini` / `gpt-4-turbo` / `llama3` 等）

可选（建议给出）
4. 并发与速率：最大同时抓取数（默认 4）、AI 并发（默认 2）、请求超时（默认 20s）
5. 单帖正文上限：例如 8000 字（超限自动摘要后再分类）
6. 是否启用“关键词簇”（只读主题词组，辅助筛选；默认开启）
7. 快捷键偏好：默认 `⌘/Ctrl + K`
8. 存储偏好：默认 IndexedDB；是否需要导入/导出入口（默认开启）
9. UI 细节：是否显示作者筛选、排序项默认值（默认：按收藏时间倒序）

## 验收标准（简要）

- 打开收藏页，悬浮窗可见；可开关、最小化
- 全部分页在后台自动抓取并合并展示；标题搜索即时过滤
- 多选标签（原生/预制/自定义）按 AND 逻辑过滤；分类可被人工编辑且持久化
- 新收藏可增量识别；AI 只从候选标签中勾选，不创造新标签
- 数据保存在本地（IndexedDB/localStorage），支持导出/导入
